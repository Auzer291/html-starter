<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Blockly Controller</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: #222;
        overflow: hidden;
      }

      #blocklyDiv {
        width: 100vw;
        height: 100vh;
      }

      #runBtn {
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 28px;
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        background-color: #1976d2;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        z-index: 9999;
      }

      .blocklyToolboxDiv {
        background: #333 !important;
      }
    </style>
  </head>

  <body>
    <div id="blocklyDiv"></div>
    <button id="runBtn">Run</button>

    <xml id="toolbox" style="display:none">
      <category name="Actions" colour="260">
        <block type="run_block"></block>
        <block type="move_forward"></block>
        <block type="rotateX_block"></block>
        <block type="rotateY_block"></block>
        <block type="rotateZ_block"></block>
        <block type="object_visible"></block>
      </category>
    </xml>

    <script>
      // Define blocks
      Blockly.defineBlocksWithJsonArray([
        {
          "type": "run_block",
          "message0": "▶ Run actions",
          "nextStatement": null,
          "colour": 120,
        },
        {
          "type": "move_forward",
          "message0": "move forward %1 units",
          "args0": [{ "type": "field_number", "name": "DIST", "value": 1 }],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 180,
        },
        {
          "type": "rotateX_block",
          "message0": "rotate X by %1°",
          "args0": [{ "type": "field_number", "name": "ANGLE", "value": 90 }],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 200,
        },
        {
          "type": "rotateY_block",
          "message0": "rotate Y by %1°",
          "args0": [{ "type": "field_number", "name": "ANGLE", "value": 90 }],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 220,
        },
        {
          "type": "rotateZ_block",
          "message0": "rotate Z by %1°",
          "args0": [{ "type": "field_number", "name": "ANGLE", "value": 90 }],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 240,
        },
        {
            "type": "object_visible",
            "message0": "set object visibility %1",
            "args0": [
                {
                "type": "field_checkbox",
                "name": "VISIBLE",
                "checked": true
                }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": 160,
            "tooltip": "Show or hide the 3D object",
            "helpUrl": ""
        }
      ]);

      const workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
      });

      // Run all blocks below "Run actions"
      function runAttachedBlocks() {
        const topBlocks = workspace.getTopBlocks(true);
        const actions = [];

        topBlocks.forEach(block => {
          if (block.type === "run_block") {
            let current = block.getNextBlock();
            while (current) {
              switch (current.type) {
                case "move_forward":
                  actions.push({
                    type: "move_forward",
                    distance: parseFloat(current.getFieldValue("DIST")),
                  });
                  break;
                case "rotateX_block":
                  actions.push({
                    type: "rotateX",
                    angle: parseFloat(current.getFieldValue("ANGLE")),
                  });
                  break;
                case "rotateY_block":
                  actions.push({
                    type: "rotateY",
                    angle: parseFloat(current.getFieldValue("ANGLE")),
                  });
                  break;
                case "rotateZ_block":
                  actions.push({
                    type: "rotateZ",
                    angle: parseFloat(current.getFieldValue("ANGLE")),
                  });
                  break;
                case "object_visible":
                    actions.push({
                    type: "object_visible",
                    visible: current.getFieldValue("VISIBLE")
                })
                  break;
              }
              current = current.getNextBlock();
            }
          }
        });

        const message = JSON.stringify({ type: "actions", actions });
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(message);
        } else {
          console.log("Actions:", message);
        }
      }

      document.getElementById("runBtn").addEventListener("click", runAttachedBlocks);
    </script>
  </body>
</html>
